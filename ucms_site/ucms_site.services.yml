parameters:

    # Master (admin) site hostname.
    ucms_site_master_hostname: admin.d8-ucms.guinevere

    # Is master HTTPs.
    ucms_site_master_is_https: false

    # If set to false, ucms_site_node_reference_whitelist is a whitelist,
    # otherwise it's a blacklist.
    ucms_site_node_reference_all: true

    # List of field names that should never be parsed to find implicit node
    # references within.
    ucms_site_node_reference_whitelist: []

    # List of allowed theme for sites, values are theme internal names, keys
    # don't matter, and will be lost.
    ucms_site_allowed_themes: [bartik, classy]

    # Allowed site types, site types don't change any business behaviour, they
    # only are a way to categorize and filter sites in admin interface.
    ucms_site_allowed_types:
        site: Site

    # Dynamic CDN hostname, must point to the same Drupal instance.
    # It may, or may not contain the scheme (http:// or https://) if none
    # provided, it will use the current one being in use.
    ucms_site_cdn_hostname: static.d8-ucms.guinevere

    # Drupal role to attach to site roles.
    # @todo THIS MUST DIE
    ucms_site_allowed_roles: ~

services:

    ###########################################################################
    #
    # Storage and managers (core feature)
    #
    ###########################################################################

    # Stores sites
    ucms_site.storage:
        public: false
        class: MakinaCorpus\Ucms\Site\CachedSiteStorage
        arguments: ["@database", "@event_dispatcher"]

    # Handles site access checks
    ucms_site.access:
        public: false
        class: MakinaCorpus\Ucms\Site\SiteAccessService
        arguments: ["@database", "@event_dispatcher"]

    # Handles sites - this is the most important component
    ucms_site.manager:
        public: true
        class: MakinaCorpus\Ucms\Site\SiteManager
        arguments:
            - "@ucms_site.storage"
            - "@ucms_site.access"
            - "@database"
            - "@event_dispatcher"
            - "@theme_handler"
            - "%ucms_site_master_hostname%"
            - "%ucms_site_master_is_https%"
            - "%ucms_site_allowed_themes%"
            - "%ucms_site_allowed_types%"
            - "%ucms_site_cdn_hostname%"

    # Handles groups
    ucms_group.manager:
        public: true
        class: MakinaCorpus\Ucms\Site\GroupManager
        arguments: ["@database", "@event_dispatcher"]

    # Handles node linking/unlinking to sites
    ucms_site.node_manager:
        public: true
        class: MakinaCorpus\Ucms\Site\NodeManager
        arguments: ["@database", "@ucms_site.manager", "@entity.manager", "@event_dispatcher"]

    ###########################################################################
    #
    # Drupal 8 integration and alteration
    #
    ###########################################################################

    # Determines the site context at bootstrap
    ucms_site.kernel.subscriber:
        public: true
        class: MakinaCorpus\Ucms\Site\Environment\KernelEventSubscriber
        arguments: ["@ucms_site.manager", "@event_dispatcher", "@config.factory"]
        tags: [{ name: event_subscriber }]

    # Overrides config using site context
    ucms_site.site_context_overrider:
        class: MakinaCorpus\Ucms\Site\Environment\SiteConfigOverrides
        arguments: ["@service_container"]
        tags: [{name: config.factory.override, priority: 1000}]

    # Custom URL generator that decorates core's one
    ucms_site.url_generator:
        public: false
        decorates: url_generator
        class: MakinaCorpus\Ucms\Site\Environment\CrossSiteUrlGenerator
        arguments: ["@ucms_site.manager", "@ucms_site.auth.token_storage", "@ucms_site.url_generator.inner", "@router.route_provider"]

    # Handles theme negociation (positionned between AdminNegociator and DefaultNegociator)
    ucms_site.theme.negotiator:
        class: MakinaCorpus\Ucms\Site\Environment\SiteThemeNegociator
        arguments: ["@service_container", "@config.factory"]
        tags: [{name: theme_negotiator, priority: -50}]

    # Handles disabled state of sites (dynamic maintenance mode)
    ucms_site.maintenance_mode:
        public: false
        decorates: maintenance_mode
        class: MakinaCorpus\Ucms\Site\Environment\SiteMaintenanceMode
        arguments: ["@ucms_site.manager", "@ucms_site.maintenance_mode.inner"]

    # Param converter for controllers and Drupal own router
    ucms_site.param_converter:
        class: MakinaCorpus\Ucms\Site\Controller\ParamConverter\SiteParamConverter
        arguments: ['@ucms_site.manager']
        tags: [{name: paramconverter}]

    # Cross sites SSO, priority will take precedence over the Drupal own
    # login provider thanks to event prioritizing.
    # Already existing session will be crushed when the login token is present. 
    # @todo is this a security issue?
    ucms_site.auth.provider:
        public: true
        class: MakinaCorpus\Ucms\Site\Environment\CrossSiteAuthProvider
        arguments: ["@ucms_site.auth.token_storage", "@entity_type.manager"]
        tags: [{name: event_subscriber}]

    # Site cache context
    cache_context.site:
        class: MakinaCorpus\Ucms\Site\Environment\SiteCacheContext
        arguments: ["@ucms_site.manager"]
        tags: [{ name: cache.context }]

    ###########################################################################
    #
    # Security and voters
    #
    ###########################################################################

    # Authentication token storage for SSO feature
    ucms_site.auth.token_storage:
        public: false
        class: MakinaCorpus\Ucms\Site\Security\AuthTokenStorage
        arguments: ["@database"]

    ucms_site.security.site_voter:
        public: false
        class: MakinaCorpus\Ucms\Site\Security\SiteVoter
        arguments: ["@ucms_site.access"]
        tags: [{name: security.voter}]

#    ucms_site.security.node_voter:
#        public: false
#        class: MakinaCorpus\Ucms\Site\Security\NodeVoter
#        tags: [{name: security.voter}]

    ucms_site.security.group_voter:
        public: false
        class: MakinaCorpus\Ucms\Site\Security\GroupVoter
        arguments: ["@ucms_group.manager"]
        tags: [{name: security.voter}]

    ###########################################################################
    #
    # Datasources
    #
    ###########################################################################

    ucms_site.datasource:
        public: true
        class: MakinaCorpus\Ucms\Site\Datasource\SiteDatasource
        arguments: ["@database", "@ucms_site.manager"]

    ucms_site.webmaster_datasource:
        public: true
        class: MakinaCorpus\Ucms\Site\Datasource\WebmasterDatasource
        arguments: ["@database", "@ucms_site.manager"]

    ###########################################################################
    #
    # Action providers
    #
    ###########################################################################

    ucms_site.core_item_loader:
        public: false
        class: MakinaCorpus\Ucms\Site\Action\CoreItemLoader
        arguments: ["@ucms_site.manager", "@entity_type.manager", "@umenu.menu_storage"]
        tags: [{name: ucms.item_loader}]

    ucms_site.site_action_provider:
        public: false
        class: MakinaCorpus\Ucms\Site\Action\SiteActionProvider
        arguments: ["@ucms_site.manager"]
        tags: [{name: ucms.action_provider}]

    ucms_site.node_action_provider:
        public: false
        class: MakinaCorpus\Ucms\Site\Action\NodeActionProvider
        arguments: ["@ucms_site.manager"]
        tags: [{name: ucms.action_provider}]

#    ucms_site.node_reference_action_provider:
#        public: false
#        class: MakinaCorpus\Ucms\Site\Action\NodeReferenceActionProvider
#        arguments: ["@entity.manager"]
#        tags: [{name: ucms.action_provider}]

    ucms_site.webmaster_action_provider:
        public: false
        class: MakinaCorpus\Ucms\Site\Action\WebmasterActionProvider
        arguments: ["@ucms_site.manager"]
        tags: [{name: ucms.action_provider}]

    ###########################################################################
    #
    # Event subscribers
    #
    ###########################################################################

    # @todo convert this to a subscriber
    ucms_site.site_event_listener:
        public: true
        class: MakinaCorpus\Ucms\Site\EventDispatcher\SiteEventListener
        arguments: ["@ucms_site.manager", "@entity.manager"]
        tags:
            - {name: event_listener, event: "site:create"}
            - {name: event_listener, event: "site:switch"}

    ucms_site.menu_event_listener:
        public: true
        class: MakinaCorpus\Ucms\Site\EventDispatcher\MenuEventListener
        arguments: ["@ucms_site.node_manager"]
        tags: [{name: event_listener, event: "menu:tree"}]

    ucms_site.menu.subscriber:
        public: true
        class: MakinaCorpus\Ucms\Site\EventDispatcher\MenuEventSubscriber
        arguments: ["@ucms_site.manager", "@umenu.manager"]
        tags: [{name: event_subscriber}]

    ucms_site.node_access.subscriber:
        public: true
        class: MakinaCorpus\Ucms\Site\EventDispatcher\NodeAccessEventSubscriber
        arguments: ["@ucms_site.manager", "@ucms_group.manager", "@sf_dic.node_access.subscriber"]
        tags: [{name: event_subscriber}]

#    ucms_site.admin_subscriber:
#        public: true
#        class: MakinaCorpus\Ucms\Site\EventDispatcher\AdminEventSubscriber
#        arguments: ["@ucms_site.manager"]
#        tags: [{ name: event_subscriber }]

    ucms_site.node_event_subscriber:
        public: true
        class: MakinaCorpus\Ucms\Site\EventDispatcher\NodeEventSubscriber
        arguments: ["@database", "@ucms_site.manager", "@ucms_site.node_manager", "@entity.manager", "@event_dispatcher", "%ucms_site_node_reference_all%", "%ucms_site_node_reference_whitelist%"]
        tags: [{name: event_subscriber}]

    ###########################################################################
    #
    # Twig integration
    #
    ###########################################################################

    ucms_site.twig.site_extension:
        public: false
        class: MakinaCorpus\Ucms\Site\Twig\Extension\SiteExtension
        arguments: ["@ucms_site.manager"]
        tags: [{ name: twig.extension }]

