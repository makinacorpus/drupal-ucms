<?php
/**
 * @file
 * UCMS - Site context and management.
 */

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\node\NodeInterface;
use MakinaCorpus\Ucms\Site\Access;
use MakinaCorpus\Ucms\Site\Site;
use MakinaCorpus\Ucms\Site\Entity\NodeDefinition;

/**
 * Implements hook_entity_base_field_info().
 */
function ucms_site_entity_base_field_info(EntityTypeInterface $entity_type) {
  switch ($entity_type->id()) {

    case 'node':
      return NodeDefinition::getAdditionalBaseFields();
  }
}

/**
 * Implements hook_menu().
 *
function ucms_site_menu() {
  $items = [];

  $items['welcome'] = [
    'title'             => "Welcome",
    'page callback'     => 'ucms_site_webmaster_home',
    'access callback'   => 'ucms_site_menu_access_manage_current',
    'type'              => MENU_CALLBACK,
  ];
  $items['admin/dashboard/site/archive'] = [
    'title'             => "Archives",
    'page callback'     => 'ucms_site_dashboard_site_list_archive',
    'access arguments'  => [Access::PERM_SITE_DASHBOARD_ACCESS],
    'type'              => MENU_LOCAL_TASK,
    'weight'            => 100,
    'file'              => 'ucms_site.dashboard.inc',
  ];

  $items['admin/dashboard/site/%ucms_site'] = [
    'title callback'    => 'ucms_site_menu_item_title',
    'title arguments'   => [3],
    'page callback'     => 'sf_dic_page',
    'page arguments'    => [DashboardController::class . '::viewAction', 3],
    'access callback'   => 'ucms_site_menu_access_overview',
    'access arguments'  => [3],
    'type'              => MENU_NORMAL_ITEM,
  ];
  $items['admin/dashboard/site/%ucms_site/view'] = [
    'title'             => "Details",
    'type'              => MENU_DEFAULT_LOCAL_TASK,
  ];
  if (module_exists('ucms_notification')) {
    $items['admin/dashboard/site/%ucms_site/log'] = [
      'title'             => "Log",
      'page callback'     => 'ucms_site_dashboard_site_page_log',
      'page arguments'    => [3],
      'access callback'   => 'ucms_site_menu_access_overview',
      'access arguments'  => [3],
      'type'              => MENU_LOCAL_TASK,
      'file'              => 'ucms_site.dashboard.inc',
    ];
  }
  $items['admin/dashboard/site/%ucms_site/edit'] = [
    'title'             => "Site edit",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\SiteEdit', 3],
    'access callback'   => 'ucms_site_menu_access_manage',
    'access arguments'  => [3],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
    'file'              => 'ucms_site.dashboard.inc',
  ];
  $items['admin/dashboard/site/%ucms_site/delete'] = [
    'title'             => "Site delete",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\SiteDelete', 3],
    'access callback'   => 'ucms_site_menu_access_manage',
    'access arguments'  => [3],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
  ];
  $items['admin/dashboard/site/%ucms_site/change-hostname'] = [
    'title'             => "Change site hostname",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => [SiteHostnameChange::class, 3],
    'access callback'   => 'ucms_site_menu_access_manage',
    'access arguments'  => [3],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
    'file'              => 'ucms_site.dashboard.inc',
  ];
  $items['admin/dashboard/site/%ucms_site/switch/%'] = [
    'title'             => "Switch site state",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\SiteSwitch', 3, 5],
    'access callback'   => 'ucms_site_menu_access_switch',
    'access arguments'  => [3, 5],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
  ];
  $items['admin/dashboard/site/%ucms_site/webmaster'] = [
    'title'             => "Users",
    'page callback'     => 'ucms_site_dashboard_site_page_webmasters',
    'page arguments'    => [3],
    'access callback'   => 'ucms_site_menu_access_webmasters',
    'access arguments'  => ['list', 3],
    'type'              => MENU_LOCAL_TASK,
    'file'              => 'ucms_site.dashboard.inc',
  ];
  $items['admin/dashboard/site/%ucms_site/webmaster/add-existing'] = [
    'title'             => "Add an existing user",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\WebmasterAddExisting', 3],
    'access callback'   => 'ucms_site_menu_access_webmasters',
    'access arguments'  => ['add-existing', 3],
    'type'              => MENU_CALLBACK,
  ];
  $items['admin/dashboard/site/%ucms_site/webmaster/add-new'] = [
    'title'             => "Create a new webmaster or contributor",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\WebmasterAddNew', 3],
    'access callback'   => 'ucms_site_menu_access_webmasters',
    'access arguments'  => ['add-new', 3],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
  ];
  $items['admin/dashboard/site/%ucms_site/webmaster/%user/change-role'] = [
    'title'             => "Change user's role",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\WebmasterChangeRole', 3, 5],
    'access callback'   => 'ucms_site_menu_access_webmasters',
    'access arguments'  => ['change-role', 3, 5],
    'type'              => MENU_CALLBACK,
  ];
  $items['admin/dashboard/site/%ucms_site/webmaster/%user/promote'] = [
    'title'             => "Promote as webmaster",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\WebmasterPromote', 3, 5],
    'access callback'   => 'ucms_site_menu_access_webmasters',
    'access arguments'  => ['promote', 3, 5],
    'type'              => MENU_CALLBACK,
  ];
  $items['admin/dashboard/site/%ucms_site/webmaster/%user/demote'] = [
    'title'             => "Demote as contributor",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\WebmasterDemote', 3, 5],
    'access callback'   => 'ucms_site_menu_access_webmasters',
    'access arguments'  => ['demote', 3, 5],
    'type'              => MENU_CALLBACK,
  ];
  $items['admin/dashboard/site/%ucms_site/webmaster/%user/delete'] = [
    'title'             => "Delete the user from this site",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\WebmasterDelete', 3, 5],
    'access callback'   => 'ucms_site_menu_access_webmasters',
    'access arguments'  => ['delete', 3, 5],
    'type'              => MENU_CALLBACK,
  ];

  $items['admin/dashboard/ajax/users-ac'] = [
    'page callback'     => 'sf_dic_page',
    'page arguments'    => [AutocompleteController::class . '::userAutocompleteAction'],
    'type'              => MENU_CALLBACK,
  ];
  $items['admin/dashboard/ajax/sites-ac'] = [
    'page callback'     => 'sf_dic_page',
    'page arguments'    => [AutocompleteController::class . '::siteAutocompleteAction'],
    'type'              => MENU_CALLBACK,
  ];

  $items['node/%node/reference'] = [
    'title'             => "Reference this content",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\NodeReference', 1],
    'access callback'   => 'ucms_site_menu_access_reference',
    'access arguments'  => [1],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
  ];
  $items['node/%node/dereference-from/%ucms_site'] = [
    'title'             => "Dereference this content from current site",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\NodeDereferenceFrom', 1, 3],
    'access callback'   => 'ucms_site_menu_access_dereference_from',
    'access arguments'  => [1, 3],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
  ];
  $items['node/%node/set-home'] = [
    'title'             => "Set as home page",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Form\NodeSetHome', 1],
    'access callback'   => 'ucms_site_menu_access_manage_current',
    'access arguments'  => [],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
  ];

  $items['node/%node/site-list'] = [
    'title'             => "Sites",
    'page callback'     => 'sf_dic_page',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Controller\NodeInfoController::siteList', 1],
    'access callback'   => 'node_access',
    'access arguments'  => ['view', 1],
    'type'              => MENU_CALLBACK | MENU_VISIBLE_IN_BREADCRUMB,
  ];

  $items['admin/structure/site'] = [
    'title'             => "Site factory configuration",
    'description'       => "Global site configuration, such as allowed themes for sites",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Admin\SiteManagementForm'],
    'access arguments'  => ['administer site configuration'],
    'type'              => MENU_NORMAL_ITEM,
  ];
  $items['admin/structure/site/global'] = [
    'title'             => "Settings",
    'type'              => MENU_DEFAULT_LOCAL_TASK,
  ];
  $items['admin/structure/site/transitions'] = [
    'title'             => "Transitions",
    'page callback'     => 'sf_dic_page_form',
    'page arguments'    => ['MakinaCorpus\Ucms\Site\Admin\SiteStateTransitionForm'],
    'access arguments'  => ['administer site configuration'],
    'type'              => MENU_LOCAL_TASK,
  ];

  return $items;
}
 */

/**
 * Implements hook_drupal_goto_alter().
 */
function ucms_site_drupal_goto_alter(&$path, &$options, &$http_response_code) {
  if (ucms_site_is_master()) {
    $matches = [];
    if (module_exists('ucms_sso') && preg_match('@^node/(\d+)(|/(view|edit))?$@', $path, $matches)) {
      $node = \Drupal::service('entity.manager')->getStorage('node')->load($matches[1]);
      if (!empty($node->site_id)) {
        $options['query'] = ['destination' => $path];
        $path = 'sso/goto/' . $node->site_id;
      }
    }
  }
}

/**
 * Title callback for menu items.
 *
 * @param Site $site
 */
function ucms_site_menu_item_title(Site $site) {
  return $site->title_admin;
}

/**
 * Implements hook_theme().
 */
function ucms_site_theme() {
  return [
    'ucms_site_state_transition_form' => [
      'render element' => 'form',
    ],
  ];
}

/**
 * Get site manager service.
 *
 * @return \MakinaCorpus\Ucms\Site\SiteManager
 */
function ucms_site_manager() {
  return \Drupal::service('ucms_site.manager');
}

/**
 * Get node access helper.
 *
 * @return \MakinaCorpus\Ucms\Site\NodeAccessService
 */
function ucms_site_node_access_helper() {
  return \Drupal::service('ucms_site.node_access_helper');
}

/**
 * Menu helper.
 */
function ucms_site_load($id) {
  try {
    return ucms_site_manager()->getStorage()->findOne($id);
  } catch (\InvalidArgumentException $e) {
    return false;
  }
}

/**
 * Menu helper.
 */
function ucms_site_menu_access_view_all($account = null) {
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  return
    $account->hasPermission(Access::PERM_SITE_MANAGE_ALL) ||
    $account->hasPermission(Access::PERM_SITE_VIEW_ALL) ||
    $account->hasPermission(Access::PERM_SITE_GOD)
  ;
}

/**
 * Menu helper.
 */
function ucms_site_menu_access_view($site, $account = null) {
  if (!$site instanceof Site) {
    return false;
  }
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  return ucms_site_manager()->getAccess()->userCanView($account, $site);
}

/**
 * Menu helper.
 */
function ucms_site_menu_access_overview($site, $account = null) {
  if (!$site instanceof Site) {
    return false;
  }
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  return ucms_site_manager()->getAccess()->userCanOverview($account, $site);
}

/**
 * Menu helper.
 */
function ucms_site_menu_access_manage_current($account = null) {
  $manager = ucms_site_manager();
  if (!$manager->hasContext()) {
    return false;
  }
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  return $manager->getAccess()->userCanManage($account, $manager->getContext());
}

/**
 * Menu helper.
 */
function ucms_site_menu_access_manage($site, $account = null) {
  if (!$site instanceof Site) {
    return false;
  }
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  return ucms_site_manager()->getAccess()->userCanManage($account, $site);
}

/**
 * Menu access check helper.
 */
function ucms_site_menu_access_switch($site, $state, $account = null) {
  if (!$site instanceof Site) {
    return false;
  }
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  return ucms_site_manager()->getAccess()->userCanSwitch($account, $site, $state);
}

/**
 * Menu access check helper.
 *
 * @param string $op The operation the user wanna perform
 * @param Site $site
 * @param AccountInterface $webmaster
 * @param AccountInterface $account
 *
 * @return boolean
 */
function ucms_site_menu_access_webmasters($op, Site $site, AccountInterface $webmaster = null, AccountInterface $account = null) {
  if (!$account) {
    $account = \Drupal::currentUser();
  }

  $manager = ucms_site_manager();

  if ($manager->getAccess()->userCanManageWebmasters($account, $site)) {
    switch ($op) {
      case 'change-role':
        // Prevents to give a role to a user which doesn't belong to the site
        if (!$manager->getAccess()->userHasRole($webmaster, $site)) {
          return false;
        }
        break;

      case 'promote':
        // Prevents to promote a user which is not a contributor of the site
        if (!$manager->getAccess()->userIsContributor($webmaster, $site)) {
          return false;
        }
        break;

      case 'demote':
        // Prevents to demote a user which is not a webmaster of the site
        if (!$manager->getAccess()->userIsWebmaster($webmaster, $site)) {
          return false;
        }
        break;
    }

    return true;
  }

  return false;
}

/**
 * Menu access check helper.
 */
function ucms_site_menu_access_reference(NodeInterface $node, $account = null) {
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  return $node->access('view', $account) && ucms_site_node_access_helper()->userCanReference($account, $node);
}

/**
 * Menu access check helper.
 */
function ucms_site_menu_access_dereference_from(NodeInterface $node, $site = null, $account = null) {
  if (!$account) {
    $account = \Drupal::currentUser();
  }
  $manager = ucms_site_manager();
  if (!$site) {
    if (!$manager->hasContext()) {
      return false;
    }
    $site = $manager->getContext();
  }
  return ucms_site_node_access_helper()->userCanDereference($account, $node, $site);
}

/**
 * Mostly copy-pasted code from drupal_fast_404(), use it wisely
 *
function ucms_site_fast_404() {
  drupal_add_http_header('Status', '404 Not Found');
  $fast_404_html = variable_get('404_fast_html', '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN" "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>404 Not Found</title></head><body><h1>Not Found</h1><p>The requested URL "@path" was not found on this server.</p></body></html>');
  // Replace @path in the variable with the page path.
  print strtr($fast_404_html, array('@path' => check_plain(request_uri())));
  exit;
}
 */

/**
 * Implements hook_module_implements_alter().
 * /
function ucms_site_module_implements_alter(&$implementations, $hook) {
  switch ($hook) {

    case 'menu_site_status_alter':
      unset($implementations['user']);
      break;

    case 'url_outbound_alter':
      // Always be the last, so that we can safely rewrite the URL
      $group = $implementations['ucms_site'];
      unset($implementations['ucms_site']);
      $implementations['ucms_site'] = $group;
      // And just set the SEO module after us, he will use our information
      $group = $implementations['ucms_seo'];
      unset($implementations['ucms_seo']);
      $implementations['ucms_seo'] = $group;
      break;
  }
}
 */

/**
 * Implements hook_menu_site_status_alter().
 * /
function ucms_site_menu_site_status_alter(&$menu_site_status, $path) {

  if (drupal_is_cli()) {
    return; // Make drush happy.
  }
  if (!ucms_site_manager()->hasContext()) {
    return; // Do not alter proper behavior on master.
  }

  // Allow SSO login when site is down.
  if ('sso/login' === current_path()) {
    $menu_site_status = MENU_SITE_ONLINE;
    return;
  }

  // Do not alter an already offline site.
  if (MENU_SITE_OFFLINE === $menu_site_status) {
    return;
  }

  $site = ucms_site_manager()->getContext();

  if (!$site) {
    return; // No site in context, nothing to check for.
  }

  if (SiteState::ON != $site->state && !ucms_site_manager()->getAccess()->userCanView(\Drupal::currentUser(), $site)) {
    $menu_site_status = MENU_SITE_OFFLINE;
    // State off means that the site is valid and up, but in maintainance mode,
    // case in which we should just set the maintainance mode and leave,
    // otherwise would mean that the site is neither ON nor OFF and does not
    // exist for the outside, so redirect to something that exists (the main
    // site). If we have nothing to redirect to, at least this code will
    // fallback on site being offline.
    if (SiteState::OFF != $site->state) {
      ucms_site_redirect_to_default();
    }
  }

  // Trigger an event allowing status alteration, only if the site is currently online.
  if (MENU_SITE_ONLINE === $menu_site_status) {
    $event = new SiteStatusEvent($site, $menu_site_status, $path);
    \Drupal::service('event_dispatcher')->dispatch(SiteStatusEvent::EVENT_NAME, $event);
    $menu_site_status = $event->getStatus();
  }
}
 */

/**
 * Implements hook_stream_wrappers_alter().
 * For CDN static domain replacement on public:// stream wrapper
 * /
function ucms_site_stream_wrappers_alter(&$wrappers) {
  // Connect our override of the public:// stream wrapper for
  // static file CDN redirection (if any)
  $wrappers['public']['class'] = PublicStreamWrapper::class;
}
 */

/**
 * Implements hook_file_url_alter
 * For CDN static domain replacement on all file related urls
 * /
function ucms_site_file_url_alter(&$original_uri) {
  $scheme = file_uri_scheme($original_uri);

  $use_cdn_here = variable_get('ucms_site_use_cdn', False);

  // local CDN Not activated?
  if (!$use_cdn_here) {
 //   return;
  }

  $cdn = variable_get('ucms_site_cdn_uri', $GLOBALS['base_url']);

  // If the current URI is an absolute or protocol-relative URI, return
  // immediately.
  // it may be an already altered public:// url
  // we do not also alter the favicon sitemap or robots files which should be
  // managed by all real domain-related sites
  if (($scheme && ($scheme === 'http' || $scheme === 'https'))
      || (drupal_substr($original_uri, 0, 2) == '//')
      || (in_array(drupal_substr($original_uri, -11), array('favicon.ico', 'sitemap.xml')))
      || (drupal_substr($original_uri, -10) == 'robots.txt')
  ) {
    return;
  }
  else if ($scheme) {

    // Explicitly exclude the local private:// stream wrapper.
    // as we do not want it managed like public files
    // And also remove the public:// stream wrapper as it is managed by
    // ucms_site_stream_wrappers_alter
    if ($scheme === 'private' || $scheme === 'public') {
      return;
    }

    // We work only on file delivered locally (not rewriting imgur things, for example)
    $local_schemes = array_keys(file_get_stream_wrappers(STREAM_WRAPPERS_LOCAL));
    if (!in_array($scheme, $local_schemes)) {
      return;
    }

    // Attempt to get an external URL using the appropriate wrapper.
    if ($wrapper = file_stream_wrapper_get_instance_by_uri($original_uri)) {
      $original_uri = str_replace($GLOBALS['base_url'] . '/', $cdn, $wrapper->getExternalUrl());
    } else {
      return;
    }
  } else {
    // classical file paths like '/foo/css/toto.css'
    $original_uri = $cdn . '/' . $original_uri;
  }
}
 */

/**
 * Redirect on node view if node can be viewed elsewhere than master.
 * /
function ucms_site_init_node_redirect() {
  if (user_is_anonymous()) { // Better be safe than sorry.
    return;
  }
  if (!ucms_site_is_master()) { // Non-applicable.
    return;
  }
  // Pure optimisation, and find node view page at the same time.
  if ('node' !== arg(0) || !is_numeric(arg(1)) || arg(2)) {
    return;
  }
  if ($node = menu_get_object()) {
    // findMostRelevantSiteFor() allows fetching URL for non enabled sites, but
    // will always find a site the current user can see. This function will
    // always be called when attempting to connect on the admin sites, so this
    // fine to redirect on non enabled sites if no enabled site was found.
    $siteId = ucms_site_node_access_helper()->findMostRelevantSiteFor($node);
    if ($siteId) {
      drupal_goto('sso/goto/' . $siteId, ['query' => ['destination' => current_path()]]);
    }
  }
}
 */

/**
 * Implements hook_init().
 * /
function ucms_site_init() {

  if (drupal_is_cli()) {
    return; // Make drush happy.
  }

  $manager = ucms_site_manager();

  // We might have some problems due to the fact that the site is determined
  // at hook_boot() time, for example, we cannot call the path_is_admin()
  // function because modules have not been invoked. Site is being set way
  // before at hook_boot() in order to ensure that everything actually using
  // this information until now does it right (they should only be revelant
  // for frontend anyway), but we have a chance right now to fix admin paths
  // and remove the site information right now.
  if ($manager->hasContext()) {
    // We avoid redirections on dashboard in case of POST requests
    // to allow layout management requests (AJAX)
    if (!ucms_site_admin_path_is_allowed(current_path())) {
      if (user_is_logged_in()) {
        // Logged-in users should not 403 on sites, but go to dashboard instead.
        ucms_site_redirect_to_master();
      }
    } else {

      // Normal runtime, there is a context, and path is not admin.
      $site = $manager->getContext();

      if ($site->title) {
        $GLOBALS['conf']['site_name'] = $site->title;
      }

      $manager->dispatchPostInit();
    }
  } else if (user_is_logged_in() && !ucms_site_is_master()) {
    ucms_site_redirect_to_master(); // Site does not exists.
  }

  ucms_site_init_node_redirect();
}
 */

/**
 * Implements hook_custom_theme().
 * /
function ucms_site_custom_theme() {

  if (path_is_admin(current_path())) {
    // Because there is actually a few admin paths that are accessible from
    // the sites themselves (node add, edit and menu tree) we can't override
    // the theme when we are working in an admin path.
    return;
  }

  // This should be called way after the hook_init() run, so we are sure the
  // site has been rightly set, and if we are in admin site has been removed,
  // so if we have a site structure, we are 100% sure we are not in an admin
  // path.
  $manager = ucms_site_manager();
  $site = $manager->getContext();

  if (!$site) {
    return;
  }

  $manager->dispatchPostInit();

  if (!$site->theme) {
    return;
  }

  // Ensure the theme is enabled for security, Drupal won't do it for
  // you, you might experience surprises. There is sadly no shortcut
  // we have to iterate over the full list of themes.
  foreach (list_themes() as $name => $data) {
    if ($site->theme === $name && $data->status) {
      return $site->theme;
    }
  }
}
 */

/**
 * Implements hook_query_TAG_alter().
 *
 * This is required in order for users that may bypass node access (UID 1 is
 * one of them) to have site content correctly isolated depending on context.
 * /
function ucms_site_query_node_access_alter(QueryAlterableInterface $query) {

  $site = ucms_site_manager()->getContext();

  if (!$site) {
    return;
  }
  if (!$query instanceof SelectQueryInterface) {
    return;
  }
  if ($query->hasTag(Access::QUERY_TAG_CONTEXT_OPT_OUT)) {
    return;
  }

  /* @var $account AccountInterface * /
  if (!$account = $query->getMetaData('account')) {
    $account = \Drupal::currentUser();
  }


  // If no base table is specified explicitly, search for one.
  $nodeAlias = null;
  foreach ($query->getTables() as $alias => $table_info) {
    if (!($table_info instanceof SelectQueryInterface)) {
      // If the node table is in the query, it wins immediately.
      if ('node' === $table_info['table']) {
        $nodeAlias = $alias;
      }
    }
  }
  if (!$nodeAlias) {
    return;
  }

  // Where the magic happens.
  $query->join(
    'ucms_site_node',
    'access_sn',
    "access_sn.nid = " . $nodeAlias . ".nid AND access_sn.site_id = :access_sn_site_id",
    [':access_sn_site_id' => $site->getId()]
  );
}
 */

/**
 * Implements hook_query_TAG_alter().
 *
 * Implement site visibility access control for the admin UI, this is the only
 * query alteration for business purpose this module will ever do.
 *
function ucms_site_query_ucms_site_access_alter(QueryAlterableInterface $query) {

  if (!$query instanceof SelectQueryInterface) {
    return;
  }
  if (drupal_is_cli()) {
    // In theory, we should not have to do this, but it happens that during
    // drush upgrade, which runs all update functions altogether one by one,
    // it may happen that this module gets enable during the same run, and
    // that the 'sf_dic' container, even if correctly rebuilt, may not be
    // used because older object references are being used by the code (old
    // services still referenced into some other being in use).
    return;
  }

  /* @var $account AccountInterface * /
  if (!$account = $query->getMetaData('account')) {
    $account = \Drupal::currentUser();
  }

  if ($account->hasPermission(Access::PERM_SITE_GOD) ||
      $account->hasPermission(Access::PERM_SITE_MANAGE_ALL) ||
      $account->hasPermission(Access::PERM_SITE_VIEW_ALL)
  ) {
    return;
  }

  /** @var \MakinaCorpus\Ucms\Site\GroupManager $groupManager * /
  $groupManager = \Drupal::service('ucms_group.manager');
  $accessList   = $groupManager->getUserGroups($account);
  $siteAlias    = null;
  $accessAlias  = null;

  // If no base table is specified explicitly, search for one.
  foreach ($query->getTables() as $alias => $table_info) {
    if (!($table_info instanceof SelectQueryInterface)) {
      // If the node table is in the query, it wins immediately.
      if ('ucms_site' === $table_info['table']) {
        $siteAlias = $alias;
      }
      if ('ucms_site_access' === $table_info['table']) {
        $accessAlias = $alias;
      }
    }
  }

  if (!$siteAlias && !$accessAlias) {
    return;
  }

  // Apply group conditions, but do not apply anything if the user is not
  // member of any groups: it means that the user is a global administrator.
  if ($accessList) {
    if (!$siteAlias) {
      $siteAlias = $query->join(
        'ucms_site',
        'access_site',
        "access_site.id = " . $accessAlias . ".site_id"
      );
    }
    $groupList = [];
    foreach ($accessList as $access) {
      $groupList[] = $access->getGroupId();
    }
    $query->condition($siteAlias . '.group_id', $groupList);
  }

  // Apply normal user permissions if the current user cannot see all sites
  if (!$account->hasPermission(Access::PERM_SITE_MANAGE_ALL) && !$account->hasPermission(Access::PERM_SITE_VIEW_ALL)) {
    if (!$accessAlias) {
      $query->join(
        'ucms_site_access',
        'access_sa',
        "access_sa.site_id = " . $siteAlias . ".id AND access_sa.uid = :access_sa_uid",
        [':access_sa_uid' => $account->id()]
      );
    } else {
      $query->condition($accessAlias . '.uid', $account->id());
    }
  }
}
 */

/**
 * Implements hook_query_TAG_alter().
 *
 * Implement site visibility access control for the admin UI, this is the only
 * query alteration for business purpose this module will ever do.
 *
function ucms_site_query_ucms_user_access_alter(QueryAlterableInterface $query) {

  if (!$query instanceof SelectQueryInterface) {
    return;
  }
  if (drupal_is_cli()) {
    // In theory, we should not have to do this, but it happens that during
    // drush upgrade, which runs all update functions altogether one by one,
    // it may happen that this module gets enable during the same run, and
    // that the 'sf_dic' container, even if correctly rebuilt, may not be
    // used because older object references are being used by the code (old
    // services still referenced into some other being in use).
    return;
  }

  /* @var $account AccountInterface * /
  if (!$account = $query->getMetaData('account')) {
    $account = \Drupal::currentUser();
  }

  if ($account->hasPermission(Access::PERM_USER_MANAGE_ALL) || $account->hasPermission(Access::PERM_USER_VIEW_ALL)) {
    return;
  }

  $userAlias = null;
  $userGroupAlias = null;

  // If no base table is specified explicitly, search for one.
  foreach ($query->getTables() as $alias => $table_info) {
    if (!($table_info instanceof SelectQueryInterface)) {
      // If the node table is in the query, it wins immediately.
      if ('users' === $table_info['table']) {
        $userAlias = $alias;
      }
      if ('ucms_group_access' === $table_info['table']) {
        $userGroupAlias = $alias;
      }
    }
  }

  if (!$userAlias) {
    return;
  }

  /** @var \MakinaCorpus\Ucms\Site\GroupManager $groupManager * /
  $groupManager = \Drupal::service('ucms_group.manager');
  $accessList   = $groupManager->getUserGroups($account);

  // Group admins can view users from their own groups, at least in listings.
  // But more than that, can ONLY see users from their groups.
  if ($accessList) {
    $groupList = [];
    foreach ($accessList as $access) {
      $groupList[] = $access->getGroupId();
    }
    if (!$userGroupAlias) {
      $userGroupAlias = $query->join('ucms_group_access', 'uga', "uga.user_id = " . $userAlias . '.uid');
    }
    $query->condition($userGroupAlias . '.group_id', $groupList);
  } else {
    $query->where("1 = 0"); // You fool.
  }
}
 */

/**
 * Implements hook_taxonomy_term_presave().
 *
function ucms_site_taxonomy_term_presave($term) {
  // Maintain term creators.
  if (empty($term->original) && !empty($GLOBALS['user']->uid)) {
    $term->user_id = $GLOBALS['user']->uid;
  }
}
 */

/**
 * Render the state transition form.
 *
function theme_ucms_site_state_transition_form($variables) {
  $form = $variables['form'];

  $header = [''];
  $rows   = [];
  $map    = SiteState::getList();

  foreach (element_children($form['transitions']) as $k1) {
    $header[] = t($map[$k1]);
    $row = [];
    $row[] = ['data' => $map[$k1], 'header' => true];
    foreach (element_children($form['transitions'][$k1]) as $k2) {
      if ($k1 != $k2) {
        $row[] = drupal_render_children($form['transitions'][$k1][$k2]);
      } else {
        $row[] = ['data' => '<span class="text-muted">' . t("N/A") . '</span>', 'style' => 'text-align: center;'];
      }
    }
    $rows[] = $row;
  }

  return theme('table', ['header' => $header, 'rows' => $rows]) . drupal_render_children($form);
}
 */

/**
 * Home page for webmasters when a site has no frontpage
 *
function ucms_site_webmaster_home() {
  drupal_set_title(t('Welcome to @site-name', array('@site-name' => variable_get('site_name', 'Drupal'))), PASS_THROUGH);

  return sf_dic_twig_render('@ucms_site/views/Site/welcome.html.twig', ['site' => ucms_site_manager()->getContext()]);
}
 */

/**
 * Preprocess dashboard top bar.
 *
 * @param $vars
 *
function ucms_site_preprocess_ucms_dashboard_top(&$vars) {
  $vars['site'] = ucms_site_manager()->getContext();
}
 */

/**
 * Implements hook_image_default_styles()
 *
 * @todo https://www.drupal.org/docs/8/theming-drupal-8/including-default-image-styles-with-your-theme
 *
function ucms_site_image_default_styles() {
  $styles = [];
  $styles['ucms_site_favicon_32x32'] = [
    'label' => 'Favicon 32x32px',
    'effects' => [
      [
        'name' => 'image_scale',
        'data' => [
          'width' => 32,
          'height' => 32,
        ],
        'weight' => 0,
      ],
    ],
    'name' => 'ucms_favicon_32x32',
    'storage' => IMAGE_STORAGE_DEFAULT,
  ];
  $styles['ucms_site_favicon_16x16'] = [
    'label' => 'Favicon 16x16px',
    'effects' => [
      [
        'name' => 'image_scale',
        'data' => [
          'width' => 16,
          'height' => 16,
        ],
        'weight' => 0,
      ],
    ],
    'name' => 'ucms_favicon_16x16',
    'storage' => IMAGE_STORAGE_DEFAULT,
  ];

  return $styles;
}
 */

/**
 * Implements hook_page_build()
 *
function ucms_site_page_build(&$page) {
  $manager = ucms_site_manager();

  if ($manager->hasContext()) {
    $site = $manager->getContext();

    // Handling custom favicon
    if ($favicon = $site->getFavicon()) {
      if ($file = file_load($favicon)) {
        $element = [
          '#tag' => 'link',
          '#attributes' => [
            'href'  => image_style_url('ucms_site_favicon_32x32', $file->uri),
            'rel'   => 'icon',
            'sizes' => "32x32"
          ],
        ];
        drupal_add_html_head($element, 'ucms_site_favicon_32x32');

        $element = [
          '#tag' => 'link',
          '#attributes' => [
            'href'  => image_style_url('ucms_site_favicon_16x16', $file->uri),
            'rel'   => 'icon',
            'sizes' => "16x16"
          ],
        ];
        drupal_add_html_head($element, 'ucms_site_favicon_16x16');
      }
    }
  }
}
 */

