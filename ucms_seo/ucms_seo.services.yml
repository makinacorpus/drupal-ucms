services:

  ucms_seo.seo_service:
    public: true
    class: MakinaCorpus\Ucms\Seo\SeoService
    arguments:
      - "@entity.manager"
      - "@path.alias_manager"
      - "@path.alias_storage"
      - "@ucms_seo.redirect_storage"
      - "@ucms_site.manager"
      - "@database"

  ucms_seo.redirect_storage:
    public: true
    class: MakinaCorpus\Ucms\Seo\Path\RedirectStorage
    arguments: ['@database', '@module_handler', "@ucms_site.manager"]

  # This overrides the global one
  path.alias_storage:
    public: true
    class: MakinaCorpus\Ucms\Seo\Path\SeoAliasStorage
    arguments: ['@database', '@module_handler', "@ucms_site.manager"]

  # Various actions providers for node and site
  ucms_seo.node_action_provider:
    public: false
    class: MakinaCorpus\Ucms\Seo\Action\NodeActionProvider
    arguments: ["@ucms_seo.seo_service", "@current_user"]
    tags: [{name: ucms_dashboard.action_provider}]
  ucms_seo.site_action_provider:
    public: false
    class: MakinaCorpus\Ucms\Seo\Action\SiteActionProvider
    arguments: ["@ucms_seo.seo_service", "@current_user"]
    tags: [{name: ucms_dashboard.action_provider}]

  # Action processors
  ucms_seo.action.alias_canonical:
    public: false
    class: MakinaCorpus\Ucms\Seo\Action\AliasCanonicalProcessor
    arguments: ["@ucms_seo.seo_service", "@current_user"]
    tags: [{name: ucms_dashboard.action}]
  ucms_seo.action.alias_delete:
    public: false
    class: MakinaCorpus\Ucms\Seo\Action\AliasDeleteProcessor
    arguments: ["@ucms_seo.seo_service", "@current_user"]
    tags: [{name: ucms_dashboard.action}]
  ucms_seo.action.redirect_delete:
    public: false
    class: MakinaCorpus\Ucms\Seo\Action\StoreLocatorAliasRebuildProcessor
    arguments: ["@ucms_seo.store_locator_factory", "@entity.manager", "@current_user"]
    tags: [{name: ucms_dashboard.action}]
  ucms_seo.action.store_locator_aliases_rebuild:
    public: false
    class: MakinaCorpus\Ucms\Seo\Action\RedirectDeleteProcessor
    arguments: ["@ucms_seo.seo_service", "@current_user"]
    tags: [{name: ucms_dashboard.action}]

  # Data sources
  ucms_seo.admin.node_alias_datasource:
    public: true
    class: MakinaCorpus\Ucms\Seo\Page\NodeAliasDatasource
    arguments: ["@database"]
  ucms_seo.admin.site_alias_datasource:
    public: true
    class: MakinaCorpus\Ucms\Seo\Page\SiteAliasDatasource
    arguments: ["@database"]
  ucms_seo.admin.node_redirect_datasource:
    public: true
    class: MakinaCorpus\Ucms\Seo\Page\NodeRedirectDatasource
    arguments: ["@database"]
  ucms_seo.admin.site_redirect_datasource:
    public: true
    class: MakinaCorpus\Ucms\Seo\Page\SiteRedirectDatasource
    arguments: ["@database"]

  twig.extension.ucms_seo:
    public: false
    class: MakinaCorpus\Ucms\Seo\Twig\SeoExtension
    arguments: ["@ucms_seo.seo_service", "@ucms_site.manager"]
    tags: [{name: twig.extension}]

  # A few various listeners
  ucms_seo.menu_event_listener:
    public: true
    class: MakinaCorpus\Ucms\Seo\EventDispatcher\MenuEventListener
    arguments: ["@ucms_seo.seo_service", "@entity.manager"]
    tags: [{name: event_listener, event: "menu:tree"}]
  ucms_seo.site_attach.subscriber:
    public: true
    class: MakinaCorpus\Ucms\Seo\EventDispatcher\SiteAttachEventListener
    arguments: ["@ucms_seo.seo_service"]
    tags: [{ name: event_subscriber }]
  ucms_seo.site_clone.subscriber:
    public: true
    class: MakinaCorpus\Ucms\Seo\EventDispatcher\SiteCloneEventListener
    arguments: ["@database"]
    tags: [{name: event_listener, event: "site:clone"}]
  ucms_seo.node_event_subscriber:
    public: true
    class: MakinaCorpus\Ucms\Seo\EventDispatcher\NodeEventSubscriber
    arguments: ["@database", "@ucms_seo.seo_service", "@ucms_site.manager", "@ucms_seo.store_locator_factory"]
    tags: [{ name: event_subscriber }]
  ucms_seo.context_pane_event_listener:
    public: true
    class: MakinaCorpus\Ucms\Seo\EventDispatcher\ContextPaneEventListener
    arguments: ["@ucms_seo.seo_service"]
    tags:
      - { name: event_listener, event: ucms_dashboard.context_init }

  # Store locator
  # @todo review the component
  ucms_seo.store_locator_factory:
    public: true
    class: MakinaCorpus\Ucms\Seo\StoreLocator\StoreLocatorFactory
    arguments: ["@ucms_seo.seo_service"]

  # Deadlinks tracking and portlet
  ucms_seo.deadlinks.portlet:
    public: false
    class: MakinaCorpus\Ucms\Seo\Portlet\DeadLinkPortlet
    arguments: ["@ucms_seo.deadlinks.datasource", "@ucms_seo.deadlinks.display"]
    tags: [{ name: ucms_dashboard.portlet }]
  ucms_seo.deadlinks.datasource:
    public: true
    class: MakinaCorpus\Ucms\Seo\Page\DeadLinkDatasource
    arguments: ["@database", "@entity.manager"]
  ucms_seo.deadlinks.display:
    public: true
    class: MakinaCorpus\Ucms\Seo\Portlet\DeadLinkPortletDisplay
    arguments: ["@entity.manager"]
  ucms_seo.deadlinks.subsriber:
    public: true
    class: MakinaCorpus\Ucms\Seo\EventDispatcher\LinkReferenceEventListener
    tags: [{ name: event_subscriber }]
